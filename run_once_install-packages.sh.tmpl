#!/usr/bin/env bash

SUDO=sudo
if [[ $EUID -eq 0 ]] ; then
    unset SUDO
fi

install_ubuntu_container() {
    $SUDO apt install -y --no-install-recommends {{ if eq .chezmoi.osRelease.versionID "20.04" }}-o Dpkg::Options::="--force-overwrite"{{ else }}zoxide hstr{{ end }} neovim fd-find ripgrep fzf htop zsh zsh-syntax-highlighting zsh-autosuggestions bat ncdu kitty-terminfo less curl git tig tree
    if ! command -v starship ; then
        sh -c "FORCE=1 $(curl -fsSL https://starship.rs/install.sh)"
    fi
    if command -v python3 &>/dev/null ; then
        $SUDO apt install -y --no-install-recommends python3-pynvim
    fi
    nvim -es -u ~/.config/nvim/init.vim -i NONE -c "PlugInstall" -c "qa"
    # TODO chsh (use systemd-homed)
}

install_ubuntu_desktop() {
    $SUDO snap install starship lxd procs
    $SUDO snap install --classic lefthook
    # Weak attempt to detect we are headless
    if [[ ! -d /usr/share/doc/ubuntu-desktop ]] ; then
        install_ubuntu_container
        exit 0
    fi
    $SUDO apt install -y neovim vim python3-pynvim flatpak zoxide fd-find ripgrep fzf htop zsh zsh-syntax-highlighting zsh-autosuggestions bat grc fonts-jetbrains-mono fonts-cascadia-code systemd-container systemd-coredump mkosi hstr ncdu papirus-icon-theme less kitty pipx fortune-mod cowsay \
                         figlet qdirstat git curl tig tree
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    flatpak install -y flathub org.signal.Signal com.spotify.Client
    if ! $SUDO systemd-detect-virt -q ; then
        flatpak install -y flathub com.valvesoftware.Steam
    fi
    nvim -es -u ~/.config/nvim/init.vim -i NONE -c "PlugInstall" -c "qa"
    # TODO chsh (use systemd-homed)
    pipx install konsave # see also: konfsave
}

install_fedora_container() {
    $SUDO dnf -y install neovim ripgrep fd-find zoxide lsd procs fzf bat zsh zsh-autosuggestions zsh-syntax-highlighting htop hstr git-delta dua-cli ncdu prettyping langpacks-core-en kitty-terminfo less curl exa tokei cloc gitui git tig ctags tree
    if command -v python &>/dev/null ; then
        $SUDO dnf -y install python3-pynvim
    fi
    $SUDO rpm --install https://github.com/evilmartians/lefthook/releases/latest/download/lefthook_amd64.rpm
    sh -c "FORCE=1 $(curl -fsSL https://starship.rs/install.sh)"
    nvim -es -u ~/.config/nvim/init.vim -i NONE -c "PlugInstall" -c "qa"
    # TODO chsh (use systemd-homed)
}

install_fedora_desktop() {
    # Weak attempt to detect we are headless
    source /etc/os-release
    if [[ "$VARIANT_ID" == "server" ]] ; then
        install_fedora_container
        exit 0
    fi
    $SUDO rpm --import https://packages.microsoft.com/keys/microsoft.asc
    echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" | $SUDO tee /etc/yum.repos.d/vscode.repo
    $SUDO dnf -y install neovim python3-neovim vim-enhanced starship ripgrep fd-find zoxide lsd procs fzf bat zsh zsh-autosuggestions zsh-syntax-highlighting kitty flatpak htop code systemd-networkd systemd-resolved systemd-container mkosi hstr git-delta dua-cli ncdu prettyping grc fortune-mod \
                         cascadia-code-pl-fonts overpass-mono-fonts ibm-plex-mono-fonts jetbrains-mono-fonts applet-window-buttons papirus-icon-theme mint-x-icons mint-y-icons mint-themes cowsay figlet doge less pipx dolphin-plugins k4dirstat qdirstat kvantum \
                         python3-dnf-plugin-post-transaction-actions python3-dnf-plugin-tracer tokei cloc exa git gitui tig ctags tree
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    flatpak install -y flathub org.signal.Signal com.spotify.Client
    if ! $SUDO systemd-detect-virt -q ; then
        $SUDO dnf -y group install --with-optional virtualization
        $SUDO dnf -y install steam-devices
        flatpak install -y flathub com.valvesoftware.Steam
        echo 'compress="zstd"' | $SUDO tee /etc/dracut.conf.d/compress.conf
    fi
    nvim -es -u ~/.config/nvim/init.vim -i NONE -c "PlugInstall" -c "qa"
    # TODO chsh (use systemd-homed)
    pipx install konsave # see also: konfsave
}

install_{{ .chezmoi.osRelease.id }}_{{ ternary "container" "desktop" .container }}
